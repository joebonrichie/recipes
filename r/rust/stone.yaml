#
# SPDX-FileCopyrightText: © 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : rust
version     : 1.91.0
release     : 29
homepage    : https://www.rust-lang.org/
upstreams   :
    - https://static.rust-lang.org/dist/rustc-1.91.0-src.tar.xz : 9b94161dba3aa32192e0e75f7891912d98095ffb86087b07a05af35a0265a938
    # - git|https://github.com/rust-lang/llvm-project.git :
    #     ref: 8c30b9c5098bdff1d3d9a2d460ee091cd1171e60 # rustc/21.1-2025-08-01
summary     : Rust programming language compiler + tools
description : |
    Rust programming language compiler + tools
license     :
    - Apache-2.0
    - BSL-1.0
    - CC-BY-4.0
    - CC-BY-NC-SA-3.0
    - CC0-1.0
    - GCC-exception-3.1
    - GPL-2.0-or-later
    - GPL-3.0-or-later
    - MIT
    - Zlib
# Enable this when bootstrapping
# networking  : true
builddeps   :
    - binary(FileCheck)
    - binary(cargo)
    - binary(cmake)
    - binary(llvm-config)
    - binary(ln)
    - binary(ninja)
    - binary(python)
    - binary(strip)
    - binary(which)
    - pkgconfig(jemalloc)
    - pkgconfig(libcurl)
    - pkgconfig(libffi)
    - pkgconfig(libgit2)
    - pkgconfig(libxml-2.0)
    - pkgconfig(oniguruma)
    - pkgconfig(openssl)
    - pkgconfig(sqlite3)
    - pkgconfig(zlib)
    - clang-32bit
environment : |
    # Don't set these here, all configuration should come from config.toml or the package.yml
    unset RUSTFLAGS

    # Force use of libsqlite3, libgit2, and libssh2 system libs
    export LIBSQLITE3_SYS_USE_PKG_CONFIG=1
    export LIBSSH2_SYS_USE_PKG_CONFIG=1
    export LIBGIT2_NO_VENDOR=1
    export RUSTONIG_SYSTEM_LIBONIG=1

    # Todo: Figure out how to link this against a dynamic libjemalloc
    export JEMALLOC_OVERRIDE=%(libdir)/libjemalloc.a

    # This needs to match which llvm we're building against. This should generally be `/usr/bin/llvm-config` but if we're using a versioned
    # package that will need to point to the versioned llvm-config
    LLVM_CONFIG=%(bindir)/llvm-config
setup       : |
    # Ensure that we use the system sqlite3
    %patch %(pkgdir)/0001-unbundle-sqlite.patch -d src/tools/cargo
    find ./vendor/libsqlite3-sys*/sqlite3/ -mindepth 1 -delete -print

    # Remove unused vendored libraries
    find ./vendor/curl-sys*/curl/ -mindepth 1 -delete -print
    find ./vendor/libffi-sys*/libffi/ -mindepth 1 -delete -print
    find ./vendor/libssh2-sys*/libssh2/ -mindepth 1 -delete -print
    find ./vendor/libz-sys*/src/zlib{,-ng}/ -mindepth 1 -delete -print
    find ./vendor/openssl-src*/openssl/ -mindepth 1 -delete -print
    find ./vendor/libgit2-sys*/libgit2/ -mindepth 1 -delete -print

    # Fix bootstrap checking checksums for all the files we just deleted
    find vendor -name .cargo-checksum.json -print \
        -exec sed -i.uncheck -e 's/"files":{[^}]*}/"files":{ }/' '{}' '+'

    # Force the libdir resolution to use lib which fixes a build failure introduced by 1.89.0
    # │B│ error[E0463]: can't find crate for `core`
    # │B│   |
    # │B│   = note: the `x86_64-unknown-linux-gnu` target may not be installed
    # │B│   = help: consider downloading the target with `rustup target add x86_64-unknown-linux-gnu`
    # │B│   = help: consider building the standard library from source with `cargo build -Zbuild-std`
    # Issue introduced by https://github.com/rust-lang/rust/pull/141729
    # `rustc --print target-libdir` should be `/usr/lib/rustlib/x86_64-unknown-linux-gnu/lib`
    %patch %(pkgdir)/0001-downstream-Hardcode-libdir-path.patch

    %patch %(pkgdir)/ldd-default.patch
build       : |
    LLVM_VERSION=$(llvm-config --version)
    LLVM_MAJOR="$( cut -d '.' -f 1 <<< "${LLVM_VERSION}" )"
    COMPILER_RT_DIR="%(libdir)/clang/${LLVM_MAJOR}/lib/linux"

    if [[ " ${PATH[*]} " =~ "ccache" ]]; then
        CCACHE_ENABLE="true"
    else
        CCACHE_ENABLE="false"
    fi

    # build.full-bootstrap=true is necessary to force the build to use the stage 1 rustc to build a stage 2 libstd. We need that for profiling data
    # We want some kind of lto enabled so that we get profiling data from it, and thin-lto is much faster to build than full lto.
    python ./x.py build \
        --build-dir %(workdir)/build-pgo \
        --config %(pkgdir)/config.toml \
        --jobs %(jobs) \
        --set build.ccache=${CCACHE_ENABLE} \
        --set build.full-bootstrap=true \
        --set rust.lto=thin-local \
        --set target.i686-unknown-linux-gnu.llvm-config="${LLVM_CONFIG}" \
        --set target.i686-unknown-linux-gnu.optimized-compiler-builtins="${COMPILER_RT_DIR}/libclang_rt.builtins-i386.a" \
        --set target.i686-unknown-linux-gnu.profiler="${COMPILER_RT_DIR}/libclang_rt.profile-i386.a" \
        --set target.x86_64-unknown-linux-gnu.llvm-config="${LLVM_CONFIG}" \
        --set target.x86_64-unknown-linux-gnu.optimized-compiler-builtins="${COMPILER_RT_DIR}/libclang_rt.builtins-x86_64.a" \
        --set target.x86_64-unknown-linux-gnu.profiler="${COMPILER_RT_DIR}/libclang_rt.profile-x86_64.a" \
        --rust-profile-generate %(workdir)/rustc-pgo-profile-data \
        --stage 2

    llvm-profdata merge -output=%(workdir)/rustc-pgo-profile-data/rustc-pgo.profdata %(workdir)/rustc-pgo-profile-data/default_*.profraw

    # rust-bootstrap is very inconsistent with the stages of various tools that it wants to build between `dist` and `install`. This
    # causes a lot of redundant and unnecessary builds if we attempt to do the build with various stages (IE build the compiler first, then the
    # tools, then install it last). To prevent this from happening just let `install` figure out what it wants.
    DESTDIR=%(installroot) python3 x.py install \
        --build-dir %(workdir)/build-release \
        --config %(pkgdir)/config.toml \
        --jobs %(jobs) \
        --set build.ccache=${CCACHE_ENABLE} \
        --set build.full-bootstrap=false \
        --set rust.lto=fat \
        --set target.i686-unknown-linux-gnu.llvm-config="${LLVM_CONFIG}" \
        --set target.i686-unknown-linux-gnu.optimized-compiler-builtins="${COMPILER_RT_DIR}/libclang_rt.builtins-i386.a" \
        --set target.i686-unknown-linux-gnu.profiler="${COMPILER_RT_DIR}/libclang_rt.profile-i386.a" \
        --set target.x86_64-unknown-linux-gnu.llvm-config="${LLVM_CONFIG}" \
        --set target.x86_64-unknown-linux-gnu.optimized-compiler-builtins="${COMPILER_RT_DIR}/libclang_rt.builtins-x86_64.a" \
        --set target.x86_64-unknown-linux-gnu.profiler="${COMPILER_RT_DIR}/libclang_rt.profile-x86_64.a" \
        --rust-profile-use %(workdir)/rustc-pgo-profile-data/rustc-pgo.profdata
install     : |
    install -Dm00644 %(installroot)/etc/bash_completion.d/* -t %(installroot)/usr/share/bash-completion/completions
    rm -rvf %(installroot)/etc

    # Remove text files from libs (manifests, installation logs...)
    find %(installroot)/%(libdir)/rustlib -maxdepth 1 -type f -delete -print
packages    :
    - "%(name)":
        paths:
            - /usr/lib/lib*.so
            - /usr/lib/rustlib/x86_64-unknown-linux-gnu
        rundeps:
            - binary(clang)
            - binary(lld)
            - compiler-rt

    - "%(name)-32bit":
        paths:
            - /usr/lib/rustlib/i686-unknown-linux-gnu
        rundeps:
            - "%(name)"
            - clang-32bit
            - compiler-rt-32bit

    - "%(name)-devel":
        paths:
            - /usr/bin/cargo-clippy
            - /usr/bin/cargo-fmt
            - /usr/bin/clippy-driver
            - /usr/bin/rust-analyzer
            - /usr/bin/rust-gdb*
            - /usr/bin/rust-lldb
            - /usr/bin/rustfmt
            - /usr/lib/rustlib/etc
            - /usr/lib/rustlib/src
            - /usr/libexec/rust-analyzer-proc-macro-srv

    - "%(name)-docs":
        paths:
            - /usr/share/doc
