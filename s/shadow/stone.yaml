#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : shadow
version     : 4.18.0
release     : 6
summary     : PAM-using login and passwd utilities
license     : BSD-3-Clause
homepage    : https://github.com/shadow-maint/shadow
description : |
    PAM-using login and passwd utilities
upstreams   :
    - https://github.com/shadow-maint/shadow/releases/download/4.18.0/shadow-4.18.0.tar.xz: add4604d3bc410344433122a819ee4154b79dd8316a56298c60417e637c07608
builddeps   :
    - binary(xsltproc)
    - pkgconfig(libacl)
    - pkgconfig(libattr)
    - pkgconfig(libcrypt)
    - pkgconfig(libeconf)
    - pkgconfig(pam)
    - docbook
    - docbook-xsl
environment : |
    %export_docbook_catalogs
setup       : |
    %patch %(pkgdir)/0001-aeryn-login.defs-changes.patch

    # TODO: Fix stateless skel patch
    # TODO: Fix man pages (requires messing with configure.ac to remove the docbook check)

    %configure \
        --enable-man \
        --enable-vendordir=%(vendordir) \
        --with-yescrypt \
        --without-libbsd \
        --without-su \
        --disable-static
build       : |
    %make
install     : |
    %make_install

    # Stateless
    %install_dir %(installroot)%(vendordir)
    mv %(installroot)/etc/login.defs %(installroot)%(vendordir)
    
    # Stateless PAM
    %install_dir %(installroot)/%(vendordir)
    mv %(installroot)/etc/pam.d %(installroot)/%(vendordir)/
    # Replace with ours
    rm -v %(installroot)/%(vendordir)/pam.d/passwd
    for i in passwd chgpasswd chpasswd newusers; do
        %install_file %(pkgdir)/pam.d/$i %(installroot)/%(vendordir)/pam.d/
    done
    for i in groupadd groupdel groupmod useradd usermod userdel; do
        %install_file %(pkgdir)/pam.d/defaults %(installroot)/%(vendordir)/pam.d/$i
    done

    # Remove files that conflict with util-linux
    # Expect logoutd, vipw, vigr, newgrp, sg to conflict also at a later point
    for file in login nologin chfn chsh; do
        find %(installroot)/usr -wholename "*bin/${file}*" -type f -exec rm {} \; # binaries
        find %(installroot)/%(vendordir) -name "${file}" -type f -exec rm {} \; # pam files
        #find %(installroot)/usr/share/man -name "*${file}*" -type f -exec rm {} \; # man pages
    done
