#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : sudo-rs
version     : 0.2.11
release     : 18
homepage    : https://github.com/trifectatechfoundation/sudo-rs
upstreams   :
    - https://github.com/trifectatechfoundation/sudo-rs/archive/refs/tags/v0.2.11.tar.gz : 86b839e1e4d73d44cedc8d38038c482852c12201fc1a415341d5f8ec3e10f7ae
summary     : A memory safe implementation of sudo and su
description : |
    A safety oriented and memory safe implementation of sudo and su written in Rust.
license     :
    - Apache-2.0
    - MIT
builddeps   :
    - binary(go-md2man)
    - pkgconfig(pam)
networking  : true
tuning      :
    - lto: thin
setup       : |
    %patch %(pkgdir)/0001-vi-sudo-Support-stateless-default-paths.patch

    %cargo_fetch
build       : |
    %cargo_build --features pam-login
install     : |
    %cargo_install sudo su visudo

    # su and sudo setuid permissions
    chmod 4755 %(installroot)%(bindir)/su
    chmod 4755 %(installroot)%(bindir)/sudo

    %install_dir %(installroot)%(sbindir)
    mv %(installroot)%(bindir)/visudo %(installroot)%(sbindir)/visudo

    %install_dir %(installroot)%(mandir)/man1
    %install_dir %(installroot)%(mandir)/man8

    %install_file %(pkgdir)/sudo.conf %(installroot)%(libdir)/tmpfiles.d/sudo.conf
    %install_file %(pkgdir)/sudo.pam %(installroot)%(vendordir)/pam.d/sudo
    %install_file %(pkgdir)/sudo.pam %(installroot)%(vendordir)/pam.d/sudo-i
    %install_file %(pkgdir)/su.pam %(installroot)/%(vendordir)/pam.d/su
    %install_file %(pkgdir)/su.pam %(installroot)/%(vendordir)/pam.d/su-l

    %install_file %(pkgdir)/sudoers %(installroot)%(vendordir)/sudo/sudoers

    # We own special permission on the dir now
    install -d -m 00750 %(installroot)%(vendordir)/sudo/sudoers.d

    go-md2man -in docs/man/su.1.md -out %(installroot)%(mandir)/man1/su.1
    go-md2man -in docs/man/sudo.8.md -out %(installroot)%(mandir)/man8/sudo.8
    go-md2man -in docs/man/visudo.8.md -out %(installroot)%(mandir)/man8/visudo.8

    %install_dir %(installroot)%(docdir)/%(name)
    TRANSITION="This is a transitional package. Please use sudo-rs"
    echo "${TRANSITION}" > %(installroot)%(docdir)/%(name)/TRANSITION
    echo "${TRANSITION}-dbginfo" > %(installroot)%(docdir)/%(name)/TRANSITION.dbginfo
    echo "${TRANSITION}-devel" > %(installroot)%(docdir)/%(name)/TRANSITION.devel

check       : |
    # Currently stateless will break some tests involving /etc/hosts
    %cargo_test --all-features || true
packages    :
    - sudo:
        summary: Transitional package for sudo-rs
        paths:
            - /usr/share/doc/sudo-rs/TRANSITION
        rundeps:
            - sudo-rs

    - sudo-dbginfo:
        summary: Transitional package for sudo-rs-dbginfo
        paths:
            - /usr/share/doc/sudo-rs/TRANSITION.dbginfo
        rundeps:
            - sudo-rs-dbginfo

    - sudo-devel:
        summary: Transitional package for sudo-rs-devel
        paths:
            - /usr/share/doc/sudo-rs/TRANSITION.devel
        rundeps:
            - sudo-rs
