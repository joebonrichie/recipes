#
# SPDX-FileCopyrightText: Â© 2020-2025 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : bcachefs-tools
version     : 1.31.11
release     : 7
homepage    : https://bcachefs.org
upstreams   :
    - https://evilpiepirate.org/bcachefs-tools/bcachefs-tools-vendored-1.31.11.tar.zst : 2df1df2aea619427509b44a1d6d6e0fbe984045380a558dd4f0aa4b2d86a8b5c
summary     : BCacheFS filesystem utilities
description : |
    BCacheFS filesystem utilities
license     : GPL-2.0-only
builddeps   :
    - binary(cargo)
    - binary(jq)
    - pkgconfig(blkid)
    - pkgconfig(libkeyutils)
    - pkgconfig(liblz4)
    - pkgconfig(libsodium)
    - pkgconfig(libudev)
    - pkgconfig(liburcu)
    - pkgconfig(libzstd)
    - pkgconfig(uuid)
    - pkgconfig(zlib)
    - libaio-devel
environment : |
    export MAKE_ARGS="PREFIX=%(prefix) ROOT_SBINDIR=%(sbindir) LIBEXECDIR=%(libdir)/bcachefs-tools"
build       : |
    %make $MAKE_ARGS
install     : |
    %make_install $MAKE_ARGS

    # Incompatible with dracut
    rm -rfv %(installroot)/usr/share/initramfs-tools

    # FUSE support is still experimental
    rm -v %(installroot)/%(sbindir)/*fuse*

    # We don't want DKMS
    rm -rfv %(installroot)/usr/src

    # Shell completions
    %install_dir %(installroot)/usr/share/{bash-completion/completions,fish/vendor_completions.d,zsh/site-functions}
    %(installroot)/%(sbindir)/bcachefs completions bash > %(installroot)/usr/share/bash-completion/completions/bcachefs
    %(installroot)/%(sbindir)/bcachefs completions fish > %(installroot)/usr/share/fish/vendor_completions.d/bcachefs.fish
    %(installroot)/%(sbindir)/bcachefs completions zsh > %(installroot)/usr/share/zsh/site-functions/_bcachefs
