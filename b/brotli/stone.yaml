#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : brotli
version     : '1.2.0'
release     : 9
summary     : Generic-purpose lossless compression algorithm
license     : MIT
homepage    : https://github.com/google/brotli
description : |
    Generic-purpose lossless compression algorithm
upstreams   :
    - git|https://github.com/google/brotli: 028fb5a23661f123017c060daa546b55cf4bde29 # v1.2.0
builddeps   :
    - pkgconfig(python3)
    - python(pkgconfig)
    - python(setuptools)
checkdeps   :
    - binary(find)
    - binary(python)
emul32      : yes
profiles    :
    - emul32:
        build: |
            %cmake_build
        install: |
            %cmake_install
        check: |
            %cmake_test
setup       : |
    %cmake \
        -DBUILD_SHARED_LIBS=True \
        -DCMAKE_INSTALL_LIBDIR=%(libdir)
build       : |
    %cmake_build

    # Python build needs brotli headers and libs, install it to a tmpdir so it can use the ones from this build
    DESTDIR="${PWD}/tmp_for_python" cmake --install "%(builddir)" --verbose

    # Setup envvars for it
    export USE_SYSTEM_BROTLI=1
    export PKG_CONFIG_PATH="${PWD}/tmp_for_python/usr/lib/pkgconfig${PKG_CONFIG_PATH:+":$PKG_CONFIG_PATH"}"
    export CFLAGS+=" -I${PWD}/tmp_for_python/usr/include"
    export LIBRARY_PATH="${PWD}/tmp_for_python/usr/lib"

    %pyproject_build
install     : |
    %cmake_install
    %pyproject_install
check       : |
    %cmake_test

    python_lib="$(find ./bin -name "lib.linux-*")"
    PYTHONPATH="$PWD/${python_lib}" python -m unittest discover python "*_test.py"
tuning      :
    - lto: full
packages    :
    - "%(name)-libs":
        summary: "Library files for %(name)"
        description: |
            Library files for %(name), typically pulled in as a dependency of another package.
        paths:
            - /usr/lib/lib*.so.*

    # Moss upgrade issue
    - "%(name)":
        rundeps:
            - "%(name)-libs"

    - "python-%(name)":
        summary: "Generic-purpose lossless compression algorithm - Python library"
        description: |
            Generic-purpose lossless compression algorithm - Python Library
        rundeps:
            - python-libs
        paths:
            - /usr/lib/python*
