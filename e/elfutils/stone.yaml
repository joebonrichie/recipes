#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : elfutils
version     : "0.194"
release     : 12
homepage    : https://sourceware.org/elfutils
upstreams   :
    - https://sourceware.org/elfutils/ftp/0.194/elfutils-0.194.tar.bz2 : 09e2ff033d39baa8b388a2d7fbc5390bfde99ae3b7c67c7daaf7433fbcf0f01e
summary     : Collection of utilities and libraries to read, create and modify ELF binary files
description : |
    elfutils is a collection of utilities and libraries to read, create and modify ELF binary files, find and handle DWARF debug data, symbols, thread state and stacktraces for processes and core files on GNU/Linux.
license     :
    - GPL-2.0-or-later
builddeps   :
    - binary(makeinfo)
    - binary(msgfmt)
    - pkgconfig(json-c)
    - pkgconfig(libarchive)
    - pkgconfig(libcurl)
    - pkgconfig(libmicrohttpd)
    - pkgconfig(sqlite3)
    - pkgconfig32(bzip2)
    - pkgconfig32(liblzma)
    - pkgconfig32(libzstd)
    - pkgconfig32(zlib)
emul32      : true
setup       : |
    %patch %(pkgdir)/rename-stack.patch
    %patch %(pkgdir)/0001-config-Hardcode-profile-to-look-in-usr-share-default.patch

    %configure \
        --disable-static \
        --enable-debuginfod \
        --with-zlib \
        --with-bzlib \
        --with-lzma \
        --with-zstd
build       : |
    %make VERBOSE=1
install     : |
    %make_install

    %install_dir %(installroot)/%(vendordir)/profile.d
    mv %(installroot)/etc/profile.d/* %(installroot)/%(vendordir)/profile.d/

    %install_dir %(installroot)/%(vendordir)/debuginfod
    echo "https://debuginfod.aerynos.dev" > %(installroot)/%(vendordir)/debuginfod/aerynos.urls

    # This had to be renamed during the build to fix a build failure, so rename it back
    mv %(installroot)/%(bindir)/eu-{eu,}stack

    find %(installroot)/%(libdir) -type f -name '*.a' -delete -print
#check       : |
#    %make check
profiles    :
    - emul32:
        setup: |
            %patch %(pkgdir)/rename-stack.patch

            %configure \
                --disable-static \
                --disable-debuginfod \
                --disable-libdebuginfod \
                --with-libarchive=no \
                --with-zlib \
                --with-bzlib \
                --with-lzma \
                --with-zstd
        install: |
            %make_install

            # Easier than messing with renaming stack
            rm -rf %(installroot)%(bindir)

            find %(installroot)/%(libdir) -type f -name '*.a' -delete -print
packages    :
    - "%(name)-libs":
        summary: Libraries for elfutils
        description: |
            Libraries for elfutils
        paths:
            - /usr/lib/lib*-*.so
            - /usr/lib/lib*.so.*

    - "%(name)-32bit":
        paths:
            - /usr/lib32/lib*-*.so
            - /usr/lib32/lib*.so.*

    - "debuginfod":
        summary: debuginfo-related http file-server daemon
        description: debuginfo-related http file-server daemon
        paths:
            - /usr/bin/debuginfod*
            - /usr/share/man/man1/debuginfod-find.1*
            - /usr/share/man/man8/debuginfod*.8*

    - "libdebuginfod":
        summary: Library to interface with debuginfod
        description: Library to interface with debuginfod
        paths:
            - /usr/lib/libdebuginfod-*.so
            - /usr/lib/libdebuginfod.so.*
            - /usr/share/defaults/
            - /usr/share/fish/
            - /usr/share/man/man7/debuginfod-client-config.7*

    - "libdebuginfod-devel":
        summary: Library to interface with debuginfod - Development files
        description: Library to interface with debuginfod - Development files
        rundeps:
            - libdebuginfod
            - libelf-devel
        paths:
            - /usr/include/elfutils/debuginfod.h
            - /usr/lib/libdebuginfod.so
            - /usr/lib/pkgconfig/libdebuginfod.pc
            - /usr/share/man/man3/debuginfod*

    - "libelf":
        summary: Library to read and write ELF files
        description: Library to read and write ELF files
        paths:
            - /usr/lib/libelf-*.so
            - /usr/lib/libelf.so.*

    - "libelf-32bit":
        summary: Library to read and write ELF files - 32bit
        description: Library to read and write ELF files - 32bit
        paths:
            - /usr/lib32/libelf-*.so
            - /usr/lib32/libelf.so.*

    - "libelf-devel":
        summary: Library to read and write ELF files
        description: Library to read and write ELF files
        rundeps:
            - libelf
        paths:
            - /usr/include/gelf.h
            - /usr/include/libelf.h
            - /usr/include/nlist.h
            - /usr/lib/pkgconfig/libelf.pc
            - /usr/lib/libelf.so
            - /usr/share/man/man3/*elf*

    - "libelf-32bit-devel":
        summary: Library to read and write ELF files
        description: Library to read and write ELF files
        rundeps:
            - libelf-32bit
            - libelf-devel
        paths:
            - /usr/lib32/libelf.so
            - /usr/lib32/pkgconfig/libelf.pc
