#
# SPDX-FileCopyrightText: © 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : cups
version     : 2.4.14
release     : 17
homepage    : https://openprinting.github.io/cups/
upstreams   :
    - https://github.com/OpenPrinting/cups/releases/download/v2.4.14/cups-2.4.14-source.tar.gz : 660288020dd6f79caf799811c4c1a3207a48689899ac2093959d70a3bdcb7699
summary     : CUPS uses IPP Everywhere™ to support printing to local and network printers.
description : |
    The current standards-based, open source printing system developed by OpenPrinting for Linux® and other Unix®-like operating systems. CUPS uses IPP Everywhere™ to support printing to local and network printers.
license     :
    - Apache-2.0
builddeps   :
    - binary(xdg-open)
    - pkgconfig(avahi-client)
    - pkgconfig(libacl)
    - pkgconfig(libcrypt)
    - pkgconfig(libssl)
    - pkgconfig(libsystemd)
    - pkgconfig(libusb-1.0)
    - pkgconfig(pam)
    - libpaper-devel
tuning      :
    - lto: full
    - optimize: size # This doesn't need to be fast, so we might as well make it small
setup       : |
    %patch %(pkgdir)/0001-stateless-cupsd.patch
    %configure \
        --with-cups-user=lp \
        --with-cups-group=lp \
        --with-rundir=/run/cups \
        --enable-libpaper \
        --enable-pam \
        --with-ondemand=systemd \
        --without-rcdir \
        --with-system-groups="wheel" \
        ac_cv_path_AR=${AR}
build       : |
    %make
install     : |
    %make_install

    %install_dir %(installroot)/usr/share/defaults/etc/
    mv %(installroot)/etc/* %(installroot)/usr/share/defaults/etc/
    %install_file %(pkgdir)/cups.pam %(installroot)%(vendordir)/pam.d/cups
    ln -s cups %(installroot)%(vendordir)/pam.d/cups.N

    %tmpfiles "d     /etc/cups           0755 root lp      -   -"
    %tmpfiles "d     /run/cups           0755 root lp      -   -"
    %tmpfiles "d     /run/cups/certs     0511 lp   lp      -   -"
    %tmpfiles "d     /var/spool/cups     0710 root lp      -   -"
    %tmpfiles "d     /var/spool/cups/tmp 1770 root lp      30d -"
    %tmpfiles "d     /var/cache/cups     0750 root lp      -   -"
    %tmpfiles "d     /var/cache/cups/rss 0750 root lp      -   -"

    rm -rvf %(installroot)/{var,run,etc}
packages    :
    - "%(name)-libs":
        summary: "Library files for %(name)"
        description: |
            Library files for %(name), typically pulled in as a dependency of another package.
        paths:
            - /usr/lib/libcups*.so.*

    - "%(name)-client":
        paths:
            - /usr/bin/cancel
            - /usr/bin/lp*
            - /usr/sbin/lpc
            - /usr/share/man/man1/cancel*
            - /usr/share/man/man1/lp*
            - /usr/share/man/man8/lpc.8*

    - "%(name)":
        rundeps:
            - "%(name)-libs"
        paths:
            - /usr/bin/lpadmin
            - /usr/bin/lpinfo
            - /usr/bin/lpmove

    - "%(name)-lpd":
        rundeps:
            - "%(name)"
        paths:
            - /usr/lib/cups/daemon/cups-lpd
            - /usr/lib/systemd/system/cups-lpd*.*
            - /usr/share/man/man8/cups-lpd.8

    - "%(name)-ipptool":
        paths:
            - /usr/bin/ipp*
            - /usr/share/cups/ipptool
            - /usr/share/man/man*/ipp*

    - "%(name)-printerapp":
        paths:
            - /usr/bin/ippeveprinter
            - /usr/lib/cups/command/ippeve*
            - /usr/share/man/man*/ippeve*

    - "%(name)-devel":
        paths:
            - /usr/bin/cups-config
            - /usr/share/man/man1/cups-config.1
