#
# SPDX-FileCopyrightText: © 2020-2024 Serpent OS Developers
# SPDX-FileCopyrightText: © 2025-     AerynOS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : ca-certificates
version     : 20250516 # TODO: Figure out what version we should use
release     : 17
homepage    : https://fedoraproject.org/wiki/CA-Certificates
# No upstreams!
summary     : Certificate Authority Files
description : |
    The Public Key Infrastructure is used for many security issues in a Linux system. In order for a certificate to be trusted, it must be signed by a trusted agent called a Certificate Authority (CA).
license     : GPL-2.0-or-later
builddeps  :
    - binary(a2x)
    - docbook
environment : |
    %export_docbook_catalogs
build       : |
    cp %(pkgdir)/update-ca-trust.8.txt .
    a2x -v -f manpage update-ca-trust.8.txt
install     : |
    etcdir="/etc/%(name)"
    ssldir="/etc/ssl"
    usrdir="/usr/share/%(name)"

    %install_file %(pkgdir)/README.* -t %(installroot)%(datadir)/doc/ca-certificates
    %install_bin %(pkgdir)/update-ca-trust
    %install_file update-ca-trust.8 -t %(installroot)%(mandir)/man8

    # The following lines are a workaround to /etc/ssl/certs being a symlink in the previous ca-certificates mechanism
    # These lines can be removed ~6 months after 2025-05-27 to ensure that users can upgrade successfully
    %tmpfiles "# Ensure that this is replaced by a directory (previous versions of AerynOS used a symlink)"
    %tmpfiles "d= ${ssldir}/certs                     0755 root root -"
    %tmpfiles ""

    %tmpfiles "# Trust source directories"
    %tmpfiles "L+ ${etcdir}/README                    - - - - ../../usr/share/doc/ca-certificates/README.etc"
    %tmpfiles "L+ ${etcdir}/trust-source/README       - - - - ../../../usr/share/doc/ca-certificates/README.src"
    %tmpfiles ""
    %tmpfiles "# Directories used by update-ca-trust"
    %tmpfiles "L+ ${ssldir}/README                    - - - - ../../usr/share/doc/ca-certificates/README.etcssl"
    %tmpfiles "L+ ${ssldir}/certs/java/README         - - - - ../../../../usr/share/doc/ca-certificates/README.java"
    %tmpfiles "L+ ${etcdir}/extracted/README          - - - - ../../../usr/share/doc/ca-certificates/README.extr"
    %tmpfiles ""
    %tmpfiles "# Compatibility link for OpenSSL using /etc/ssl as CAdir"
    %tmpfiles "L+ ${ssldir}/cert.pem                  - - - - ../ca-certificates/extracted/tls-ca-bundle.pem"
    %tmpfiles "# Compatibility link for legacy bundle (Debian)"
    %tmpfiles "L+ ${ssldir}/certs/ca-certificates.crt - - - - ../../ca-certificates/extracted/tls-ca-bundle.pem"
    %tmpfiles "# Compatibility link for legacy bundle (RHEL/Fedora)"
    %tmpfiles "L+ ${ssldir}/certs/ca-bundle.crt       - - - - ../../ca-certificates/extracted/tls-ca-bundle.pem"

    %install_dir %(installroot)/${usrdir}/trust-source
    ln -srv %(installroot)/usr/share/doc/ca-certificates/README.usr %(installroot)/${usrdir}/trust-source/README

    %install_file %(pkgdir)/trigger.yaml %(installroot)/usr/share/moss/triggers/sys.d/ca_certificates.yaml

    # Ca-certificates
    %install_dir %(installroot)%(docdir)/%(name)
    echo "This file will disappear when virtual packages are introduced" > %(installroot)%(docdir)/%(name)/VIRTUAL
packages    :
    - "%(name)-utils":
        summary: Common CA certificates (utilities)
        description: Common CA certificates (utilities)
        rundeps:
            - binary(bash)
            - binary(find)
            - binary(ln)
            - binary(trust)
        paths:
            - /usr/bin
            - /usr/lib/tmpfiles.d
            - /usr/share/ca-certificates
            - /usr/share/doc/ca-certificates
            - /usr/share/man/man8/update-ca-trust.8*
            - /usr/share/moss

    - "%(name)":
        rundeps:
            - ca-certificates-mozilla
        paths:
            - /usr/share/doc/ca-certificates/VIRTUAL
