From f6f3471e5048ac74a9fe1b4541680239419459d9 Mon Sep 17 00:00:00 2001
From: Lumir Balhar <lbalhar@redhat.com>
Date: Thu, 9 Feb 2023 15:13:36 +0100
Subject: [PATCH] moss wheels
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Co-Authored-By: Miro HronÄ¨ok <miro@hroncok.cz>
---
 src/virtualenv/run/__init__.py                |  5 +++--
 src/virtualenv/seed/embed/base_embed.py       | 16 +++++++++++++-
 src/virtualenv/seed/embed/pip_invoke.py       |  1 +
 .../seed/embed/via_app_data/via_app_data.py   |  1 +
 src/virtualenv/seed/wheels/acquire.py         |  3 ++-
 src/virtualenv/seed/wheels/embed/__init__.py  |  4 ++++
 src/virtualenv/util/path/_system_wheels.py    | 22 +++++++++++++++++++
 7 files changed, 48 insertions(+), 4 deletions(-)
 create mode 100644 src/virtualenv/util/path/_system_wheels.py

diff --git a/src/virtualenv/run/__init__.py b/src/virtualenv/run/__init__.py
index 6d54eb1..de613eb 100644
--- a/src/virtualenv/run/__init__.py
+++ b/src/virtualenv/run/__init__.py
@@ -98,8 +98,9 @@ def build_parser_only(args=None):
 
 def handle_extra_commands(options):
     if options.upgrade_embed_wheels:
-        result = manual_upgrade(options.app_data, options.env)
-        raise SystemExit(result)
+        # result = manual_upgrade(options.app_data, options.env)
+        logging.warning("virtualenv installed from the moss package uses wheels from moss packages as well. Updating them via virtualenv is not possible. The moss packaged wheels are updated together with other moss packages of the system.")
+        raise SystemExit(1)
 
 
 def load_app_data(args, parser, options):
diff --git a/src/virtualenv/seed/embed/base_embed.py b/src/virtualenv/seed/embed/base_embed.py
index 72fc5a3..cf5dad2 100644
--- a/src/virtualenv/seed/embed/base_embed.py
+++ b/src/virtualenv/seed/embed/base_embed.py
@@ -7,9 +7,10 @@ from pathlib import Path
 
 from virtualenv.seed.seeder import Seeder
 from virtualenv.seed.wheels import Version
+from virtualenv.util.path._system_wheels import get_system_wheels_paths
 
 LOGGER = logging.getLogger(__name__)
-PERIODIC_UPDATE_ON_BY_DEFAULT = True
+PERIODIC_UPDATE_ON_BY_DEFAULT = False
 
 
 class BaseEmbed(Seeder, ABC):
@@ -44,6 +45,15 @@ class BaseEmbed(Seeder, ABC):
 
         if not self.distribution_to_versions():
             self.enabled = False
+ 
+        if "embed" in (self.pip_version, self.setuptools_version, getattr(self, "wheel_version", None)):
+            raise RuntimeError(
+                "Embedded wheels are not available if virtualenv "
+                "is installed from the moss package.\nEither install "
+                "virtualenv from PyPI (via pip) or use 'bundle' "
+                "version which uses the system-wide pip, setuptools "
+                "and wheel wheels provided also by moss packages."
+            )
 
     @classmethod
     def distributions(cls) -> dict[str, Version]:
@@ -135,6 +145,10 @@ class BaseEmbed(Seeder, ABC):
             result += f" {distribution}{ver},"
         return result[:-1] + ")"
 
+    def insert_system_wheels_paths(self, creator):
+        system_wheels_paths = get_system_wheels_paths(creator.interpreter)
+        self.extra_search_dir = list(system_wheels_paths) + self.extra_search_dir
+
 
 __all__ = [
     "BaseEmbed",
diff --git a/src/virtualenv/seed/embed/pip_invoke.py b/src/virtualenv/seed/embed/pip_invoke.py
index b733c51..5bc355f 100644
--- a/src/virtualenv/seed/embed/pip_invoke.py
+++ b/src/virtualenv/seed/embed/pip_invoke.py
@@ -18,6 +18,7 @@ class PipInvoke(BaseEmbed):
     def run(self, creator):
         if not self.enabled:
             return
+        self.insert_system_wheels_paths(creator)
         for_py_version = creator.interpreter.version_release_str
         with self.get_pip_install_cmd(creator.exe, for_py_version) as cmd:
             env = pip_wheel_env_run(self.extra_search_dir, self.app_data, self.env)
diff --git a/src/virtualenv/seed/embed/via_app_data/via_app_data.py b/src/virtualenv/seed/embed/via_app_data/via_app_data.py
index a2e9630..de63ecb 100644
--- a/src/virtualenv/seed/embed/via_app_data/via_app_data.py
+++ b/src/virtualenv/seed/embed/via_app_data/via_app_data.py
@@ -41,6 +41,7 @@ class FromAppData(BaseEmbed):
     def run(self, creator):
         if not self.enabled:
             return
+        self.insert_system_wheels_paths(creator)
         with self._get_seed_wheels(creator) as name_to_whl:
             pip_version = name_to_whl["pip"].version_tuple if "pip" in name_to_whl else None
             installer_class = self.installer_class(pip_version)
diff --git a/src/virtualenv/seed/wheels/acquire.py b/src/virtualenv/seed/wheels/acquire.py
index 5ca610f..1cb807b 100644
--- a/src/virtualenv/seed/wheels/acquire.py
+++ b/src/virtualenv/seed/wheels/acquire.py
@@ -35,11 +35,12 @@ def get_wheel(  # noqa: PLR0913
 
     if download and wheel is None and version != Version.embed:
         # 2. download from the internet
+        from virtualenv.util.path._system_wheels import get_system_wheels_paths
         wheel = download_wheel(
             distribution=distribution,
             version_spec=Version.as_version_spec(version),
             for_py_version=for_py_version,
-            search_dirs=search_dirs,
+            search_dirs=get_system_wheels_paths(sys),
             app_data=app_data,
             to_folder=app_data.house,
             env=env,
diff --git a/src/virtualenv/seed/wheels/embed/__init__.py b/src/virtualenv/seed/wheels/embed/__init__.py
index 6b3ef26..be45048 100644
--- a/src/virtualenv/seed/wheels/embed/__init__.py
+++ b/src/virtualenv/seed/wheels/embed/__init__.py
@@ -39,7 +39,11 @@ BUNDLE_SUPPORT = {
 MAX = "3.8"
 
 
+# Redefined here because bundled wheels are removed in moss build
+BUNDLE_SUPPORT = None
+
 def get_embed_wheel(distribution, for_py_version):
+    return None  # BUNDLE_SUPPORT == None anyway
     mapping = BUNDLE_SUPPORT.get(for_py_version, {}) or BUNDLE_SUPPORT[MAX]
     wheel_file = mapping.get(distribution)
     if wheel_file is None:
diff --git a/src/virtualenv/util/path/_system_wheels.py b/src/virtualenv/util/path/_system_wheels.py
new file mode 100644
index 0000000..f3fd9b1
--- /dev/null
+++ b/src/virtualenv/util/path/_system_wheels.py
@@ -0,0 +1,22 @@
+from pathlib import Path
+from subprocess import check_output, CalledProcessError
+
+
+def get_system_wheels_paths(interpreter):
+    # ensurepip wheels
+    # We need subprocess here to check ensurepip with the Python we are creating
+    # a new virtual environment for
+    executable = interpreter.executable
+    try:
+        ensurepip_path = check_output((executable, "-u", "-c", 'import ensurepip; print(ensurepip.__path__[0])'), universal_newlines=True)
+        ensurepip_path = Path(ensurepip_path.strip()) / "_bundled"
+    except CalledProcessError:
+        pass
+    else:
+        if ensurepip_path.is_dir():
+            yield ensurepip_path
+
+    # Standard wheels path
+    wheels_dir = Path("/usr/share/python-wheels")
+    if wheels_dir.exists():
+        yield wheels_dir
-- 
2.49.0

