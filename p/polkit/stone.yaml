#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : polkit
version     : "127"
release     : 10
summary     : Application-level authorization toolkit
license     : GPL-2.0-or-later
homepage    : https://github.com/polkit-org/polkit
description : |
    polkit is an application-level toolkit for defining and handling the policy that allows unprivileged processes to speak to privileged processes: It is a framework for centralizing the decision making process with respect to granting access to privileged operations for unprivileged applications. See the polkit(8) manual page for more detailed information.
upstreams   :
    - https://github.com/polkit-org/polkit/archive/refs/tags/127.tar.gz: 9b7bc16f086479dcc626c575976568ba4a85d34297a750d8ab3d2e57f6d8b988
builddeps   :
    - binary(msgfmt)
    - binary(perl)
    - binary(xsltproc)
    - pkgconfig(duktape)
    - pkgconfig(expat)
    - pkgconfig(gio-2.0)
    - pkgconfig(gobject-introspection-1.0)
    - pkgconfig(libsystemd)
    - pkgconfig(pam)
    - docbook
    - docbook-xsl
environment : |
    %export_docbook_catalogs
setup       : |
    %patch %(pkgdir)/stateless/0001-pkexec-Support-a-stateless-configuration.patch

    %meson \
        -Dos_type=redhat \
        -Dsession_tracking=logind \
        -Dexamples=false \
        -Dman=true \
        -Dgtk_doc=false \
        -Dtests=false
    # TODO build gtk_docs
build       : |
    %meson_build
install     : |
    %meson_install

    # Trigger to reload dbus whenever necessary
    %install_file %(pkgdir)/trigger.yaml %(installroot)/usr/share/moss/triggers/sys.d/reload_polkit.yaml

    # tmpfiles
    # Delete the upstream version
    rm -v %(installroot)%(tmpfilesdir)/polkit-tmpfiles.conf
    %tmpfiles "d /var/empty 0755 - - -"
    %tmpfiles "d /etc/polkit-1/rules.d 0750 root polkitd -"

    # Statelessness
    %install_dir %(installroot)/%(vendordir)
    mv %(installroot)/usr/lib/pam.d/ %(installroot)/%(vendordir)

    # userdb
    %install_file %(pkgdir)/polkitd.group %(installroot)%(libdir)/userdb/polkitd.group
    ln -s polkitd.group %(installroot)%(libdir)/userdb/27.group
    %install_file %(pkgdir)/polkitd.user %(installroot)%(libdir)/userdb/polkitd.user
    ln -s polkitd.user %(installroot)%(libdir)/userdb/27.user
    rm -fr %(installroot)%(libdir)/sysusers.d

    # Allow the active user to change the timezone or NTP settings
    # https://community.kde.org/Distributions/Packaging_Recommendations#Polkit_configuration
    %install_file %(pkgdir)/00-ntp-and-time-zones.rules %(installroot)%(datadir)/polkit-1/rules.d/00-ntp-and-time-zones.rules

    # TODO: Capabilities

# TODO checks (needs python-dbusmock)
packages    :
    - "%(name)-libs":
        summary: Libraries for %(name)
        description: Libraries for %(name)
        paths:
            - /usr/lib/lib*.so.*
            - /usr/lib/girepository-1.0/*.typelib

    - "%(name)-devel":
        paths:
            - /usr/share/gettext/its/
