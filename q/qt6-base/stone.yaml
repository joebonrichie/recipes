#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : qt6-base
version     : 6.9.3
release     : 17
homepage    : https://www.qt.io
upstreams   :
    - https://download.qt.io/official_releases/qt/6.9/6.9.3/submodules/qtbase-everywhere-src-6.9.3.tar.xz : c5a1a2f660356ec081febfa782998ae5ddbc5925117e64f50e4be9cd45b8dc6e
summary     : Cross platform application and UI framework
description : |
    Cross platform application and UI framework
license     :
    - GPL-2.0
    - LGPL-2.1-or-later
    - LGPL-3.0-or-later
builddeps   :
    - cmake(VulkanHeaders)
    - cmake(double-conversion)
    - pkgconfig(atspi-2)
    - pkgconfig(cups)
    - pkgconfig(dbus-1)
    - pkgconfig(fontconfig)
    - pkgconfig(freetype2)
    - pkgconfig(gbm)
    - pkgconfig(gl)
    - pkgconfig(glib-2.0)
    - pkgconfig(gtk+-3.0)
    - pkgconfig(harfbuzz)
    - pkgconfig(ice)
    - pkgconfig(icu-uc)
    - pkgconfig(krb5-gssapi)
    - pkgconfig(libb2)
    - pkgconfig(libbrotlicommon)
    - pkgconfig(libcrypto)
    - pkgconfig(libdrm)
    - pkgconfig(libinput)
    - pkgconfig(libmariadb)
    - pkgconfig(libjpeg)
    - pkgconfig(libpcre2-16)
    - pkgconfig(libpng)
    - pkgconfig(libproxy-1.0)
    - pkgconfig(libsystemd)
    - pkgconfig(libudev)
    - pkgconfig(libzstd)
    - pkgconfig(md4c)
    - pkgconfig(mtdev)
    - pkgconfig(sm)
    - pkgconfig(sqlite3)
    - pkgconfig(tslib)
    - pkgconfig(vulkan)
    - pkgconfig(wayland-client)
    - pkgconfig(wayland-egl-backend)
    - pkgconfig(wayland-server)
    - pkgconfig(xcb)
    - pkgconfig(xcb-atom)
    - pkgconfig(xcb-cursor)
    - pkgconfig(xcb-icccm)
    - pkgconfig(xcb-image)
    - pkgconfig(xcb-keysyms)
    - pkgconfig(xcb-randr)
    - pkgconfig(xcb-renderutil)
    - pkgconfig(xkbcommon)
    - pkgconfig(xkbcommon-x11)
    - pkgconfig(zlib)
    # TODO:
    # libsctp, odbc, interbase, postgres, lttng-ust
setup       : |
    %patch %(pkgdir)/0001-Adjust-build-flags.patch
    %patch %(pkgdir)/0001-Support-stateless-config-directories.patch

    # Upstream backports
    %patch %(pkgdir)/0001-Drop-CMAKE_SYSTEM_VERSION-from-modules-json-if-Linux.patch

    ## 2024-01-18 Note
    # Enabling -DQT_FEATURE_openssl_hash=ON with Qt 6.6.1 seems to break some applications use of TLS.
    # This can be reproduced in rssguard by starting it and trying to pull some feeds. You'll see the following message right before a ton of SSL errors:
    # "Random number generator not seeded, disabling SSL support"
    ## 2024-12-03 update: Still fucked

    %cmake_qt6 \
        -DQT_QMAKE_TARGET_MKSPEC=linux-clang \
        -DQT_FEATURE_accessibility=ON \
        -DQT_FEATURE_brotli=ON \
        -DQT_FEATURE_dbus_linked=ON \
        -DQT_FEATURE_emojisegmenter=ON \
        -DQT_FEATURE_gssapi=ON \
        -DQT_FEATURE_harfbuzz=ON \
        -DQT_FEATURE_journald=ON \
        -DQT_FEATURE_libproxy=ON \
        -DQT_FEATURE_mimetype_database=OFF \
        -DQT_FEATURE_mtdev=ON \
        -DQT_FEATURE_openssl_linked=ON \
        -DQT_FEATURE_optimize_full=ON \
        -DQT_FEATURE_pcre2=ON \
        -DQT_FEATURE_system_harfbuzz=ON \
        -DQT_FEATURE_system_sqlite=ON \
        -DQT_FEATURE_system_xcb_xinput=ON \
        -DQT_FEATURE_zstd=ON
build       : |
    %ccache_zero

    %cmake_build

    %ccache_stats
install     : |
    %cmake_install

    # Setup user-facing binaries (like qmake6)
    %qt_user_facing_links

    # Avoid debug logging unless overridden by user
    %install_file %(pkgdir)/qtlogging.ini %(installroot)/usr/share/qt6/qtlogging.ini

    # If we used ccache during this build then the ccache config key will be used for EVERY qt6 package build. We want to avoid that.
    sed -i "s| ccache||g" %(installroot)/%(libdir)/qt6/mkspecs/qmodule.pri
    sed -i "s| ccache||g" %(installroot)/%(libdir)/qt6/mkspecs/modules/qt_lib_core_private.pri

    # We have the dedicated qt6-docs package for that.
    rm -rfv %(installroot)/%(datadir)/doc

    # Used for Qt CI
    rm -rfv %(installroot)%(libdir)/qt6/ensure_pro_file.cmake \
            %(installroot)%(libdir)/qt6/qt-android-runner.py \
            %(installroot)%(libdir)/qt6/qt-testrunner.py \
            %(installroot)%(libdir)/qt6/sanitizer-testrunner.py

    # Not used for desktop installs
    rm -rfv %(installroot)%(libdir)/cmake/Qt6ExamplesAssetDownloaderPrivate \
            %(installroot)%(includedir)/qt6/QtExamplesAssetDownloader \
            %(installroot)%(libdir)/qt6/metatypes/qt6examplesassetdownloaderprivate*.json \
            %(installroot)%(libdir)/qt6/modules/ExamplesAssetDownloaderPrivate.json \
            %(installroot)%(libdir)/libQt6ExamplesAssetDownloader* \
            %(installroot)%(libdir)/qt6/mkspecs/features/uikit
packages    :
    - "%(name)":
        rundeps:
            - shared-mime-info

    - "%(name)-gui":
        summary: Qt6 GUI-related libraries
        description: Qt6 GUI-related libraries
        paths:
            - /usr/lib/libQt6Egl*so.*
            - /usr/lib/libQt6Gui.so.*
            - /usr/lib/libQt6OpenGL.so.*
            - /usr/lib/libQt6OpenGLWidgets.so.*
            - /usr/lib/libQt6PrintSupport.so.*
            - /usr/lib/libQt6Widgets.so.*
            - /usr/lib/libQt6XcbQpa.so.*
            - /usr/lib/qt6/plugins/egldeviceintegrations/*.so
            - /usr/lib/qt6/plugins/platforms/*.so
            - /usr/lib/qt6/plugins/generic/libqevdev*.so
            - /usr/lib/qt6/plugins/generic/libqlibinputplugin.so
            - /usr/lib/qt6/plugins/generic/libqtslibplugin.so
            - /usr/lib/qt6/plugins/generic/libqtuiotouchplugin.so
            - /usr/lib/qt6/plugins/imageformats/*.so
            - /usr/lib/qt6/plugins/platforminputcontexts/*.so
            - /usr/lib/qt6/plugins/platformthemes/*.so
            - /usr/lib/qt6/plugins/printsupport/*.so
            - /usr/lib/qt6/plugins/xcbglintegrations/*.so

    - "%(name)-mysql":
        summary: Qt6 MySQL driver
        description: Qt6 MySQL driver
        paths:
            - /usr/lib/qt6/plugins/sqldrivers/libqsqlmysql.so

    - "%(name)-devel":
        paths:
            - /usr/bin
            - /usr/lib/qt6/*.cmake
            - /usr/lib/qt6/android_emulator_launcher.sh
            - /usr/lib/qt6/bin
            - /usr/lib/qt6/cmake_automoc_parser
            - /usr/lib/qt6/moc
            - /usr/lib/qt6/qlalr
            - /usr/lib/qt6/qt-cmake-private*
            - /usr/lib/qt6/qt-cmake-standalone-test
            - /usr/lib/qt6/qt-internal-configure-examples
            - /usr/lib/qt6/qt-internal-configure-tests
            - /usr/lib/qt6/rcc
            - /usr/lib/qt6/qvkgen
            - /usr/lib/qt6/syncqt
            - /usr/lib/qt6/tracegen
            - /usr/lib/qt6/tracepointgen
            - /usr/lib/qt6/uic
        rundeps:
            - "%(name)-gui"
            - "%(name)-mysql"
            - cmake(VulkanHeaders)
            - pkgconfig(gl)
            - pkgconfig(libzstd)
            - pkgconfig(vulkan)
            - pkgconfig(xcb-cursor)
            - pkgconfig(xcb-icccm)
            - pkgconfig(xcb-keysyms)
            - pkgconfig(xcb-util)
            - pkgconfig(xkbcommon)

    # NOTE: If something has this as a builddep it needs to be rebuilt on version updates.
    - "%(name)-private-devel":
        paths:
            - /usr/include/qt6/QtEgl*
            - /usr/include/qt6/Qt*/6.*/
            - /usr/lib/cmake/Qt6Egl*
            - /usr/lib/cmake/Qt6*Private
            - /usr/lib/libQt6Egl*.prl
            - /usr/lib/libQt6Egl*.so
            - /usr/lib/qt6/modules/Egl*.json
            - /usr/lib/qt6/modules/XcbQpaPrivate.json
            - /usr/lib/qt6/metatypes/qt6egl*.json
            - /usr/lib/qt6/metatypes/qt6xcb*.json
            - /usr/lib/qt6/modules/TestInternalsPrivate.json
        rundeps:
            - "%(name)-devel"
            - pkgconfig(cups)

    - "%(name)-staticlib":
        paths:
            - /usr/lib/lib*.a
            - /usr/lib/libQt6DeviceDiscoverySupport.prl
            - /usr/lib/libQt6ExampleIcons.prl
            - /usr/lib/libQt6FbSupport.prl
            - /usr/lib/libQt6InputSupport.prl
            - /usr/lib/libQt6KmsSupport.prl
            - /usr/lib/qt6/modules/DeviceDiscoverySupportPrivate.json
            - /usr/lib/qt6/modules/ExampleIconsPrivate.json
            - /usr/lib/qt6/modules/FbSupportPrivate.json
            - /usr/lib/qt6/modules/InputSupportPrivate.json
            - /usr/lib/qt6/modules/KmsSupportPrivate.json
            - /usr/lib/qt6/metatypes/qt6devicediscoverysupportprivate_*metatypes.json
            - /usr/lib/qt6/metatypes/qt6exampleiconsprivate_*metatypes.json
            - /usr/lib/qt6/metatypes/qt6fbsupportprivate_*metatypes.json
            - /usr/lib/qt6/metatypes/qt6inputsupportprivate_*metatypes.json
            - /usr/lib/qt6/metatypes/qt6kmssupportprivate_*metatypes.json
            - /usr/lib/objects-*
            - /usr/lib/cmake/Qt6DeviceDiscoverySupportPrivate
            - /usr/lib/cmake/Qt6ExampleIconsPrivate
            - /usr/lib/cmake/Qt6FbSupportPrivate
            - /usr/lib/cmake/Qt6InputSupportPrivate
            - /usr/lib/cmake/Qt6KmsSupportPrivate
            - /usr/include/qt6/QtDeviceDiscoverySupport
            - /usr/include/qt6/QtExampleIcons
            - /usr/include/qt6/QtFbSupport
            - /usr/include/qt6/QtInputSupport
            - /usr/include/qt6/QtKmsSupport
        rundeps:
            - "%(name)-devel"
