From 400713caebb51e17046c7d884e08729a27cfa505 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Tim=20R=C3=BChsen?= <tim.ruehsen@gmx.de>
Date: Sun, 2 Feb 2025 19:42:40 +0100
Subject: [PATCH] Fix redirect regression

* src/wget.c (process_response_header): Follow location header.

Fixes https://gitlab.com/gnuwget/wget2/-/issues/689
Reported-by: https://gitlab.com/omos
---
 src/wget.c | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/src/wget.c b/src/wget.c
index a2358fed6..3713db6eb 100644
--- a/src/wget.c
+++ b/src/wget.c
@@ -1907,6 +1907,16 @@ static int process_response_header(wget_http_response *resp)
 
 		wget_cookie_normalize_cookies(job->iri, resp->cookies);
 		wget_cookie_store_cookies(config.cookie_db, resp->cookies);
+
+		wget_buffer uri_buf;
+		char uri_sbuf[1024];
+		wget_buffer_init(&uri_buf, uri_sbuf, sizeof(uri_sbuf));
+
+		wget_iri_relative_to_abs(iri, resp->location, (size_t) -1, &uri_buf);
+		if (uri_buf.length)
+			queue_url_from_remote(job, "utf-8", uri_buf.data, URL_FLG_REDIRECTION, NULL);
+
+		wget_buffer_deinit(&uri_buf);
 	}
 
 	return 0;
-- 
GitLab

