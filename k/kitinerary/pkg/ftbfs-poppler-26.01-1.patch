From c190329a17895f0e793c00910f37a64d0efeb421 Mon Sep 17 00:00:00 2001
From: Volker Krause <vkrause@kde.org>
Date: Thu, 8 Jan 2026 19:29:21 +0100
Subject: [PATCH] Adapt to Poppler 26.02 API removal

---
 src/lib/pdf/pdfextractoroutputdevice.cpp | 21 +++++++++++++++++++++
 src/lib/pdf/pdfextractoroutputdevice_p.h | 11 +++++++++++
 2 files changed, 32 insertions(+)

diff --git a/src/lib/pdf/pdfextractoroutputdevice.cpp b/src/lib/pdf/pdfextractoroutputdevice.cpp
index a652655e0..2ad933cd2 100644
--- a/src/lib/pdf/pdfextractoroutputdevice.cpp
+++ b/src/lib/pdf/pdfextractoroutputdevice.cpp
@@ -313,3 +313,24 @@ void PdfExtractorOutputDevice::processLink(AnnotLink *link)
     PdfLink l(QString::fromStdString(uriLink->getURI()), QRectF(QPointF(std::min(xu1, xu2), std::min(yu1, yu2)), QPointF(std::max(xu1, xu2), std::max(yu1, yu2))));
     m_links.push_back(std::move(l));
 }
+
+#if KPOPPLER_VERSION >= QT_VERSION_CHECK(26, 1, 90)
+void PdfExtractorOutputDevice::setDefaultCTM(const std::array<double, 6> &ctm)
+{
+    TextOutputDev::setDefaultCTM(ctm);
+
+    const double det = 1 / (ctm[0] * ctm[3] - ctm[1] * ctm[2]);
+    m_defICTM[0] = ctm[3] * det;
+    m_defICTM[1] = -ctm[1] * det;
+    m_defICTM[2] = -ctm[2] * det;
+    m_defICTM[3] = ctm[0] * det;
+    m_defICTM[4] = (ctm[2] * ctm[5] - ctm[3] * ctm[4]) * det;
+    m_defICTM[5] = (ctm[1] * ctm[4] - ctm[0] * ctm[5]) * det;
+}
+
+void PdfExtractorOutputDevice::cvtDevToUser(double dx, double dy, double *ux, double *uy) const
+{
+    *ux = m_defICTM[0] * dx + m_defICTM[2] * dy + m_defICTM[4];
+    *uy = m_defICTM[1] * dx + m_defICTM[3] * dy + m_defICTM[5];
+}
+#endif
diff --git a/src/lib/pdf/pdfextractoroutputdevice_p.h b/src/lib/pdf/pdfextractoroutputdevice_p.h
index 1ec6d0029..1ce83f201 100644
--- a/src/lib/pdf/pdfextractoroutputdevice_p.h
+++ b/src/lib/pdf/pdfextractoroutputdevice_p.h
@@ -25,6 +25,10 @@ class PdfExtractorOutputDevice : public TextOutputDev
 public:
     explicit PdfExtractorOutputDevice();
 
+#if KPOPPLER_VERSION >= QT_VERSION_CHECK(26, 1, 90)
+    void setDefaultCTM(const std::array<double, 6> &ctm) override;
+#endif
+
     // call once displaying has been completed
     void finalize();
 
@@ -61,6 +65,13 @@ public:
 
     // extracted links
     std::vector<PdfLink> m_links;
+
+private:
+#if KPOPPLER_VERSION >= QT_VERSION_CHECK(26, 1, 90)
+    // removed in Poppler 26.02
+    void cvtDevToUser(double dx, double dy, double *ux, double *uy) const;
+    std::array<double, 6> m_defICTM;
+#endif
 };
 
 }
-- 
GitLab

