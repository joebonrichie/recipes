#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : openjdk-17
version     : 17.0.17
release     : 1
upstreams   :
    - https://github.com/openjdk/jdk17u/archive/refs/tags/jdk-17.0.17-ga.tar.gz:
        hash: e2d1d92a4a593d9a87054ea54f76fcb6119f782c57945506a2ec4adff6ddc123
        unpackdir: "jdk"
    # BOOTSTRAPPIN
    - https://github.com/adoptium/temurin17-binaries/releases/download/jdk-17.0.17%2B10/OpenJDK17U-jdk_x64_linux_hotspot_17.0.17_10.tar.gz:
        hash: 992f96e7995075ac7636bb1a8de52b0c61d71ed3137fafc979ab96b4ab78dd75
        unpackdir: "jdk/bootstrap-jdk"
    # Detection seems broken, we can't use system gtest (TODO fix this)
    - https://github.com/google/googletest/archive/refs/tags/v1.14.0.tar.gz:
        hash: 8ad598c73ad796e0d8280b082cebd82a630d73e73cd3c70057938a6501bba5d7
        unpackdir: "jdk/gtest-local"
homepage    : https://openjdk.java.net/
summary     : Open implementation of Oracle's Java Development Kit, major version 17
description : |
    Open implementation of Oracle's Java Development Kit, major version 17. This package includes the JDK, the JRE is not separately provided.
license     :
    - GPL-2.0-or-later
networking  : true
builddeps   :
    - binary(awk)
    - binary(c++filt)
    - binary(git)
    - binary(gnu-sort)
    - binary(make)
    - binary(sed)
    - binary(tar)
    - binary(unzip)
    - binary(zip)
    - pkgconfig(alsa)
    - pkgconfig(cups)
    - pkgconfig(fontconfig)
    - pkgconfig(harfbuzz)
    - pkgconfig(ice)
    - pkgconfig(lcms2)
    - pkgconfig(libjpeg)
    - pkgconfig(x11)
    - pkgconfig(xext)
    - pkgconfig(xrandr)
    - pkgconfig(xrender)
    - pkgconfig(xt)
    - pkgconfig(xtst)
    - giflib-devel
rundeps-exclude:
    - 'soname\(libjvm\.so\(.*\)\)'
setup       : |
    # Set to 1 to bootstrap
    _bootstrap=1

    # TODO package jtreg so we can run tests (post bootstrapping)
    # TODO at some point when we have conflicts it should be feasible to package the JRE

    %patch %(pkgdir)/0001-Force-gnu-mode-for-date.patch

    # ccache needs to be enabled via conf option, not by setting the path
    if [[ " ${PATH[*]} " =~ "ccache" ]]; then
        export PATH="${PATH//\/usr\/lib\/ccache\/bin:/}"
        export extra_conf_opts="--enable-ccache"
    fi

    if [[ ${_bootstrap} == "1" ]]; then
        export extra_conf_opts+=" --with-boot-jdk='%(workdir)/bootstrap-jdk'"
    fi

    # Git commit that corresponds to version
    export GITCOMMIT=$(git ls-remote https://github.com/openjdk/jdk17u.git refs/tags/jdk-%(version)-ga^{} | awk '{print $1}')
    # Basically this finds the git tag with the same commit as the `version-ga` format and then
    # parses it with regex to extract the -build part (so `17.0.17-ga` to match `17.0.17-10` and the output is `10`)
    export _version_build=$(git ls-remote https://github.com/openjdk/jdk17u.git | \
                            grep ${GITCOMMIT} | \
                            sed '/-ga^{}/d' | \
                            awk '{print $2}' | \
                            sed -nr "s/.*%(version)\+(.*)\^.*/\1/p")
    echo "Version build detected as ${_version_build}"

    chmod +x configure
    %configure \
        --prefix="%(installroot)/usr" \
        --disable-warnings-as-errors \
        --disable-absolute-paths-in-output \
        --with-jvm-features=link-time-opt \
        --with-native-debug-symbols=internal \
        --with-stdc++lib=dynamic \
        --with-toolchain-type=clang \
        --with-version-build="${_version_build}" \
        --with-version-pre="" \
        --with-version-opt="aeryn" \
        --with-vendor-name=AerynOS \
        --with-vendor-url=https://AerynOS.com/ \
        --with-vendor-bug-url=https://github.com/AerynOS/recipes/issues \
        --with-vendor-vm-bug-url=https://github.com/AerynOS/recipes/issues \
        --with-freetype=system \
        --with-giflib=system \
        --with-harfbuzz=system \
        --with-lcms=system \
        --with-libjpeg=system \
        --with-libpng=system \
        --with-zlib=system \
        --with-extra-cflags="${CFLAGS}" \
        --with-extra-cxxflags="${CXXFLAGS}" \
        --with-extra-ldflags="${LDFLAGS}" \
        --with-jobs=%(jobs) \
        AR="${AR}" \
        NM="${NM}" \
        OBJCOPY="${OBJCOPY}" \
        OBJDUMP="llvm-objdump" \
        SORT="/usr/bin/gnu-sort" \
        STRIP="${STRIP}" \
        $extra_conf_opts
build       : |
    %ccache_zero

    make images test-image

    %ccache_stats
install     : |
    make install

    jvm_dir="%(libdir)/openjdk-17"
    %install_dir %(installroot)/%(libdir)
    mv %(installroot)/%(prefix)/jvm/openjdk-* %(installroot)/${jvm_dir}
    rmdir %(installroot)/%(prefix)/jvm

    # Remove license files and demo files
    rm -rfv %(installroot)/${jvm_dir}/{legal,demo}/

    # System headers
    %install_dir %(installroot)/%(includedir)/openjdk-17
    mv %(installroot)/${jvm_dir}/include/* %(installroot)/%(includedir)/openjdk-17
    ln -srvf %(installroot)/%(includedir)/openjdk-17 %(installroot)/${jvm_dir}/include

    # Man pages
    %install_dir %(installroot)/%(datadir)
    mv %(installroot)/${jvm_dir}/man %(installroot)/%(datadir)
    find %(installroot)/%(mandir) -type f -print -exec rename -- ".1" "-17.1" {} \;

    # System JVM symlinks for applications that check for this path
    %install_dir %(installroot)/%(libdir)/jvm
    ln -srv %(installroot)/${jvm_dir} %(installroot)/%(libdir)/jvm/openjdk-17

    # Fix binary symlinks
    pushd %(installroot)/%(bindir)
    for bin in *; do
        rm -v ${bin}
        if test -f %(installroot)/${jvm_dir}/bin/${bin}; then
            ln -srv %(installroot)/${jvm_dir}/bin/${bin} ${bin}-17
        fi
    done
    popd
tuning      :
    - lto: false # Enabled by argument instead
