#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : openssl
version     : 3.5.4
release     : 32
summary     : OpenSSL cryptography library
license     :
    - OpenSSL
    - SSLeay
homepage    : https://www.openssl.org
description : |
    OpenSSL cryptography library.
upstreams   :
    - https://www.openssl.org/source/openssl-3.5.4.tar.gz: 967311f84955316969bdb1d8d4b983718ef42338639c621ec4c34fddef355e99
builddeps   :
    - binary(perl)
    - pkgconfig32(libzstd)
    - pkgconfig32(zlib)
    - libatomic-32bit
emul32      : true
profiles    :
    - emul32:
        install: |
            %make_install MANSUFFIX=openssl
            rm -v %(installroot)%(libdir)/*.a
environment : |
    # OpenSSL is rife with strict aliasing violations and we really need to build it with this flag to be safe
    # https://github.com/openssl/openssl/issues/12247
    export CFLAGS+=" -fno-strict-aliasing"
setup       : |
    %patch %(pkgdir)/stateless/0001-Use-OS-provided-copy-of-openssl.cnf-as-fallback.patch
    %patch %(pkgdir)/config.patch
    %patch %(pkgdir)/0001-Fix-soname-dynamic-loading.patch

    if [[ %(target_triple) = i686* ]]; then
        export OSSL_TARGET="linux-x86-clang"
        _extra_opts=""
    else
        export OSSL_TARGET=linux-x86_64-clang""
        _extra_opts="enable-ec_nistp_64_gcc_128"
    fi

    # We may want to add brotli support for compressed certificates, but as far as I know that's not common yet
    ./Configure $OSSL_TARGET \
        --prefix=/usr \
        --libdir=lib%(libsuffix) \
        --openssldir=/etc/ssl \
        enable-ktls \
        enable-zstd-dynamic \
        no-rc4 \
        shared \
        zlib-dynamic \
        ${_extra_opts}
build       : |
    %make
install     : |
    %make_install MANSUFFIX=openssl
    rm -v %(installroot)%(libdir)/*.a

    # Stateless
    %install_dir %(installroot)/%(vendordir)
    mv %(installroot)/etc/ssl %(installroot)/%(vendordir)/
    rmdir %(installroot)/etc
    rmdir %(installroot)/%(vendordir)/ssl/certs
    rmdir %(installroot)/%(vendordir)/ssl/private

    # TODO: Can we just delete c_rehash now that we manage certificates properly in ca-certificates?
tuning      :
    - lto: false # https://github.com/openssl/openssl/issues/18663
packages    :
    - "%(name)-libs":
        summary: "Library files for %(name)"
        description: |
            Library files for %(name), typically pulled in as a dependency of another package.
        rundeps:
            # These are dlopened()
            - soname(libz.so.1(x86_64))
            - soname(libzstd.so.1(x86_64))
        paths:
            - /usr/lib/libcrypto.so.*
            - /usr/lib/libssl.so.*
            - /usr/lib/engines-*
            - /usr/lib/ossl-modules

    - "%(name)-32bit":
        rundeps:
            - soname(libz.so.1(386))
            - soname(libzstd.so.1(386))
    - "%(name)-docs":
        paths:
            - /usr/share/doc/*
