#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : openjdk-21
version     : 21.0.9
release     : 1
upstreams   :
    - https://github.com/openjdk/jdk21u/archive/refs/tags/jdk-21.0.9-ga.tar.gz:
        hash: 4ffe05ff839192b01ed53ccd69835f7b5508bee7ca0d5703ac210897065e7ff0
        unpackdir: "jdk"
    # BOOTSTRAPPIN
    - https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.9%2B10/OpenJDK21U-jdk_x64_linux_hotspot_21.0.9_10.tar.gz:
        hash: 810d3773df7e0d6c4394e4e244b264c8b30e0b05a0acf542d065fd78a6b65c2f
        unpackdir: "jdk/bootstrap-jdk"
    # Detection seems broken, we can't use system gtest (TODO fix this)
    - https://github.com/google/googletest/archive/refs/tags/v1.14.0.tar.gz:
        hash: 8ad598c73ad796e0d8280b082cebd82a630d73e73cd3c70057938a6501bba5d7
        unpackdir: "jdk/gtest-local"
homepage    : https://openjdk.java.net/
summary     : Open implementation of Oracle's Java Development Kit, major version 21
description : |
    Open implementation of Oracle's Java Development Kit, major version 21. This package includes the JDK, the JRE is not separately provided.
license     :
    - GPL-2.0-or-later
networking  : true
builddeps   :
    - binary(awk)
    - binary(c++filt)
    - binary(git)
    - binary(gnu-sort)
    - binary(make)
    - binary(sed)
    - binary(tar)
    - binary(unzip)
    - binary(zip)
    - pkgconfig(alsa)
    - pkgconfig(cups)
    - pkgconfig(fontconfig)
    - pkgconfig(harfbuzz)
    - pkgconfig(ice)
    - pkgconfig(lcms2)
    - pkgconfig(libjpeg)
    - pkgconfig(x11)
    - pkgconfig(xext)
    - pkgconfig(xrandr)
    - pkgconfig(xrender)
    - pkgconfig(xt)
    - pkgconfig(xtst)
    - giflib-devel
rundeps-exclude:
    - 'soname\(libjvm\.so\(.*\)\)'
setup       : |
    # Set to 1 to bootstrap
    _bootstrap=1

    # TODO package jtreg so we can run tests (post bootstrapping)
    # TODO at some point when we have conflicts it should be feasible to package the JRE

    %patch %(pkgdir)/0001-Force-gnu-mode-for-date.patch

    # ccache needs to be enabled via conf option, not by setting the path
    if [[ " ${PATH[*]} " =~ "ccache" ]]; then
        export PATH="${PATH//\/usr\/lib\/ccache\/bin:/}"
        export extra_conf_opts="--enable-ccache"
    fi

    if [[ ${_bootstrap} == "1" ]]; then
        export extra_conf_opts+=" --with-boot-jdk='%(workdir)/bootstrap-jdk'"
    fi

    # Git commit that corresponds to version
    export GITCOMMIT=$(git ls-remote https://github.com/openjdk/jdk21u.git refs/tags/jdk-%(version)-ga^{} | awk '{print $1}')
    # Basically this finds the git tag with the same commit as the `version-ga` format and then
    # parses it with regex to extract the -build part (so `21.0.9-ga` to match `21.0.9-10` and the output is `10`)
    export _version_build=$(git ls-remote https://github.com/openjdk/jdk21u.git | \
                            grep ${GITCOMMIT} | \
                            sed '/-ga^{}/d' | \
                            awk '{print $2}' | \
                            sed -nr "s/.*%(version)\+(.*)\^.*/\1/p")
    echo "Version build detected as ${_version_build}"

    chmod +x configure
    %configure \
        --prefix="%(installroot)/usr" \
        --disable-warnings-as-errors \
        --disable-absolute-paths-in-output \
        --with-jvm-features=link-time-opt \
        --with-native-debug-symbols=internal \
        --with-stdc++lib=dynamic \
        --with-toolchain-type=clang \
        --with-version-build="${_version_build}" \
        --with-version-pre="" \
        --with-version-opt="aeryn" \
        --with-vendor-name=AerynOS \
        --with-vendor-url=https://AerynOS.com/ \
        --with-vendor-bug-url=https://github.com/AerynOS/recipes/issues \
        --with-vendor-vm-bug-url=https://github.com/AerynOS/recipes/issues \
        --with-freetype=system \
        --with-giflib=system \
        --with-harfbuzz=system \
        --with-lcms=system \
        --with-libjpeg=system \
        --with-libpng=system \
        --with-zlib=system \
        --with-extra-cflags="${CFLAGS}" \
        --with-extra-cxxflags="${CXXFLAGS}" \
        --with-extra-ldflags="${LDFLAGS}" \
        --with-jobs=%(jobs) \
        AR="${AR}" \
        NM="${NM}" \
        OBJCOPY="${OBJCOPY}" \
        OBJDUMP="llvm-objdump" \
        SORT="/usr/bin/gnu-sort" \
        STRIP="${STRIP}" \
        $extra_conf_opts
build       : |
    %ccache_zero

    make images test-image

    %ccache_stats
install     : |
    jvm_dir="%(libdir)/openjdk-21"
    %install_dir %(installroot)${jvm_dir}
    cp -ra build/linux-x86_64-server-release/images/jdk/* %(installroot)${jvm_dir}

    # Remove license files and demo files
    rm -rfv %(installroot)/${jvm_dir}/{legal,demo}/

    # System headers
    %install_dir %(installroot)/%(includedir)/openjdk-21
    mv %(installroot)/${jvm_dir}/include/* %(installroot)/%(includedir)/openjdk-21
    ln -srvf %(installroot)/%(includedir)/openjdk-21 %(installroot)/${jvm_dir}/include

    # Man pages
    %install_dir %(installroot)/%(datadir)
    mv %(installroot)/${jvm_dir}/man %(installroot)/%(datadir)
    find %(installroot)/%(mandir) -type f -print -exec rename -- ".1" "-21.1" {} \;

    # System JVM symlinks for applications that check for this path
    %install_dir %(installroot)/%(libdir)/jvm
    ln -srv %(installroot)/${jvm_dir} %(installroot)/%(libdir)/jvm/openjdk-21

    # Fix binary symlinks
    %install_dir %(installroot)%(bindir)
    pushd %(installroot)/${jvm_dir}/bin
    for bin in *; do
        ln -srv %(installroot)/${jvm_dir}/bin/${bin} %(installroot)%(bindir)/${bin}-21
    done
    popd
tuning      :
    - lto: false # Enabled by argument instead
