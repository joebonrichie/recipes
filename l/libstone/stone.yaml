#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : libstone
version     : "0.26.1+git.647000c"
release     : 7
homepage    : https://github.com/serpent-os/tools
upstreams   :
    - git|https://github.com/AerynOS/os-tools.git : 647000ce6c4570ae451359ac87639df57c060db8
summary     : Library to read .stone archives
description : |
    Library to read .stone archives
license     : MPL-2.0
networking  : yes
builddeps   :
    - binary(patchelf)
    - cargo-c
setup       : |
    %cargo_fetch
build       : |
    cargo cbuild \
              -p libstone \
              --prefix=/usr \
              --frozen \
              --release
install     : |
    cargo cinstall \
      -p libstone \
      --destdir=%(installroot) \
      --libdir=%(libdir) \
      --release \
      --frozen \
      --prefix=/usr

    soname=$(readlink %(installroot)%(libdir)/libstone.so)

    # Expose major version as DT_SONAME to avoid minor version link breakage
    #
    # Rust follows symver and doesn't do this by default for `0.x.x` pre-stable
    # version. Until we stabilize `libstone` to `1.x.x`, this is needed
    ln -s $soname %(installroot)%(libdir)/libstone.so.0
    patchelf --set-soname libstone.so.0 %(installroot)%(libdir)/$soname

    rm -v %(installroot)%(libdir)/*.a
