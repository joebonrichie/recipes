#
# SPDX-FileCopyrightText: Â© 2020-2024 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : ldc
version     : 1.41.0
release     : 21
summary     : The LLVM-based D Compiler
license     :
    - Apache-2.0
    - BSD-3-Clause
    - BSL-1.0
homepage    : https://github.com/ldc-developers/ldc
description : |
    The LLVM-based D Compiler
upstreams   :
    - https://github.com/ldc-developers/ldc/releases/download/v1.41.0/ldc-1.41.0-src.tar.gz:
        hash: af52818b60706106fb8bca2024685c54eddce929edccae718ad9fbcf689f222f
        unpackdir: "ldc"
    - https://github.com/ldc-developers/ldc/releases/download/v1.41.0/ldc2-1.41.0-linux-x86_64.tar.xz:
        hash: 4a439457f0fe59e69d02fd6b57549fc3c87ad0f55ad9fb9e42507b6f8e327c8f
        stripdirs: 1
        unpackdir: "ldc/bootstrap/"
builddeps   :
    - binary(ldc2)
    - binary(llvm-config-20)
    - pkgconfig(zlib)
    - binary(make)
    - compiler-rt-20
    - lld-20-devel
    - ldc-static
setup       : |
    # Set to 1 to rebootstrap, make sure you uncomment the dmd compiler from the upstreams
    _bootstrap=1

    %patch %(pkgdir)/stateless/0001-Fixups-for-packaging-and-stateless-config.patch
    %patch %(pkgdir)/0001-Link-against-libLLVM.so-for-LLVMSymbolize-symbols.patch

    # We use CMAKE_SKIP_INSTALL_RPATH instead of CMAKE_SKIP_RPATH because the former makes it so that we use rpath
    # during building and linking but strip it when installing. This means we can link ldc against the runtime we just built.
    function ldc_configure() {
        %cmake \
           -DADDITIONAL_DEFAULT_LDC_SWITCHES="\"-link-defaultlib-shared\"," \
           -DBASH_COMPLETION_COMPLETIONSDIR="%(completionsdir)" \
           -DBUILD_LTO_LIBS=ON \
           -DBUILD_SHARED_LIBS=BOTH \
           -DCMAKE_INSTALL_PREFIX=/usr \
           -DCMAKE_SKIP_INSTALL_RPATH=ON \
           -DLDC_DYNAMIC_COMPILE=OFF \
           -DLDC_INSTALL_LTOPLUGIN=ON \
           -DLDC_WITH_LLD=ON \
           -DLLVM_CONFIG=%(bindir)/llvm-config-20 \
           -DPHOBOS_SYSTEM_ZLIB=ON \
           "$@"
    }

    if [[ ${_bootstrap} == "1" ]]; then
        ldc_configure \
            -DCMAKE_EXE_LINKER_FLAGS="-fuse-ld=lld" \
            -DD_COMPILER=%(buildroot)/ldc/bootstrap/bin/ldmd2
    else
        ldc_configure \
            -DD_COMPILER_FLAGS="-link-defaultlib-shared=false --flto=thin"
    fi
build       : |
    %cmake_build
install     : |
    %cmake_install

    %install_dir %(installroot)/%(libdir)/bfd-plugins
    ln -srf %(installroot)/%(libdir)/LLVMgold-ldc.so %(installroot)/%(libdir)/bfd-plugins/LLVMgold-ldc.so

    # Stateless: Put file in patched stateless location
    %install_dir %(installroot)/usr/share/defaults/ldc2
    mv %(installroot)/etc/ldc2.conf %(installroot)/%(vendordir)/ldc2/ldc2.conf

    rmdir -v %(installroot)/etc

    # TODO: Remove once we can remove packages from the index
    mkdir -p %(installroot)/usr/share/doc/replace/
    touch %(installroot)/usr/share/doc/replace/%(name)-devel
packages    :
    - "%(name)":
        paths:
            - /usr/include
            - /usr/lib/*.so
        rundeps:
            - "%(name)-libs"
            - "%(name)-libs-debug"
            - compiler-rt-20

    - "%(name)-libs":
        summary: Runtime libs for ldc
        description: Runtime libs for ldc
        paths:
            - /usr/lib/libdruntime*.so.*
            - /usr/lib/libphobos2*.so.*

    - "%(name)-libs-debug":
        summary: Runtime libs for ldc - debug versions
        description: Runtime libs for ldc - debug versions
        paths:
            - /usr/lib/libdruntime*debug*.so.*
            - /usr/lib/libphobos2*debug*.so.*

    - "%(name)-static":
        summary: Runtime libs for ldc - static
        description: Runtime libs for ldc - static
        paths:
            - /usr/lib/libdruntime*.a
            - /usr/lib/libphobos2*.a
        rundeps:
            - "%(name)"
            - pkgconfig(zlib) # For `-lz`

    - "%(name)-devel":
        paths:
            - /usr/share/doc/replace/ldc-devel
        rundeps:
            - "%(name)"
## TODO: Add boulder macros and DFLAG support to boulder
