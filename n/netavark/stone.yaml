#
# SPDX-FileCopyrightText: Â© 2020-2025 Serpent OS Developers
#
# SPDX-License-Identifier: MPL-2.0
#
name        : netavark
version     : 1.17.1
release     : 2
upstreams   :
    - https://github.com/containers/netavark/archive/refs/tags/v1.17.1.tar.gz : 22cdaea57490014c8faf029d0e2d585d9fddcfcb35fc342f812ba79b27d5d3d1
homepage    : https://github.com/containers/netavark
license     : Apache-2.0
summary     : OCI network stack
description : |
    Netavark is a rust based network stack for containers. It is being
    designed to work with Podman but is also applicable for other OCI
    container management applications.
networking  : true
builddeps   :
    - binary(protoc)
    # mandown for man pages
rundeps     :
    - sysbinary(nft)
    - aardvark-dns
setup       : |
    %cargo_fetch
build       : |
    export NETAVARK_DEFAULT_FW=nftables
    %cargo_build

    # We're not using the make file
    sed "s|@@NETAVARK@@|%(libdir)/podman/%(name)|" contrib/systemd/system/netavark-dhcp-proxy.service.in > contrib/systemd/system/netavark-dhcp-proxy.service
    sed "s|@@NETAVARK@@|%(libdir)/podman/%(name)|" contrib/systemd/system/netavark-nftables-reload.service.in > contrib/systemd/system/netavark-nftables-reload.service
    # Note that there is firewalld integration files for whenever that's packaged
install     : |
    %install_exe %(cargo_target_dir)/%(name) -t %(installroot)%(libdir)/podman

    %install_file contrib/systemd/system/netavark-dhcp-proxy.{service,socket} -t %(installroot)%(libdir)/systemd/system
    %install_file contrib/systemd/system/netavark-nftables-reload.service -t %(installroot)%(libdir)/systemd/system
    %install_file %(pkgdir)/%(name).preset -t %(installroot)/%(libdir)/systemd/system-preset
